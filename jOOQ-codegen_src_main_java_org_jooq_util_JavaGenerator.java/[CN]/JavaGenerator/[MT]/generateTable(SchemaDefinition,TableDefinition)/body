{
  UniqueKeyDefinition primaryKey=table.getPrimaryKey();
  final boolean updatable=generateRelations() && primaryKey != null;
  final String className=getStrategy().getJavaClassName(table);
  final String fullClassName=getStrategy().getFullJavaClassName(table);
  final String fullTableId=getStrategy().getFullJavaIdentifier(table);
  final String recordType=getStrategy().getFullJavaClassName(table,Mode.RECORD);
  final List<String> interfaces=getStrategy().getJavaClassImplements(table,Mode.DEFAULT);
  final String comment=defaultString(table.getComment());
  log.info("Generating table",getStrategy().getFileName(table) + " [input=" + table.getInputName()+ ", output="+ table.getOutputName()+ ", pk="+ (primaryKey != null ? primaryKey.getName() : "N/A")+ "]");
  JavaWriter out=new JavaWriter(getStrategy().getFile(table));
  printPackage(out,table);
  printClassJavadoc(out,table);
  out.println("public class %s extends %s<%s>[[before= implements ][%s]] {",className,TableImpl.class,recordType,interfaces);
  out.printSerial();
  printSingletonInstance(out,table);
  printRecordTypeMethod(out,table);
  for (  ColumnDefinition column : table.getColumns()) {
    final String columnType=getJavaType(column.getType());
    final String columnTypeRef=getJavaTypeReference(column.getDatabase(),column.getType());
    final String columnId=getStrategy().getJavaIdentifier(column);
    final String columnName=column.getName();
    final String columnComment=StringUtils.defaultString(column.getComment());
    final CustomType columnCustomType=database.getConfiguredCustomType(column.getType().getUserType());
    String isStatic=generateInstanceFields() ? "" : "static ";
    String tableRef=generateInstanceFields() ? "this" : getStrategy().getJavaIdentifier(table);
    out.tab(1).javadoc("The column <code>%s</code>.%s",column.getQualifiedOutputName(),defaultIfBlank(" " + columnComment,""));
    if (columnCustomType != null) {
      String converter=columnCustomType.getConverter();
      out.tab(1).println("public %sfinal %s<%s, %s> %s = createField(\"%s\", %s, %s, \"%s\", new %s());",isStatic,TableField.class,recordType,columnType,columnId,columnName,columnTypeRef,tableRef,escapeString(columnComment),converter);
    }
 else {
      out.tab(1).println("public %sfinal %s<%s, %s> %s = createField(\"%s\", %s, %s, \"%s\");",isStatic,TableField.class,recordType,columnType,columnId,columnName,columnTypeRef,tableRef,escapeString(columnComment));
    }
  }
  if (generateInstanceFields()) {
    out.tab(1).javadoc("Create a <code>%s</code> table reference",table.getQualifiedOutputName());
    out.tab(1).println("public %s() {",className);
  }
 else {
    out.tab(1).javadoc(NO_FURTHER_INSTANCES_ALLOWED);
    out.tab(1).println("private %s() {",className);
  }
  out.tab(2).println("this(\"%s\", null);",table.getOutputName());
  out.tab(1).println("}");
  final String schemaId=getStrategy().getFullJavaIdentifier(schema);
  if (generateInstanceFields()) {
    out.tab(1).javadoc("Create an aliased <code>%s</code> table reference",table.getQualifiedOutputName());
    out.tab(1).println("public %s(%s alias) {",className,String.class);
    out.tab(2).println("this(alias, %s);",fullTableId);
    out.tab(1).println("}");
  }
  out.println();
  out.tab(1).println("private %s(%s alias, %s<%s> aliased) {",className,String.class,Table.class,recordType);
  out.tab(2).println("this(alias, aliased, null);");
  out.tab(1).println("}");
  out.println();
  out.tab(1).println("private %s(%s alias, %s<%s> aliased, %s<?>[] parameters) {",className,String.class,Table.class,recordType,Field.class);
  out.tab(2).println("super(alias, %s, aliased, parameters, \"%s\");",schemaId,escapeString(comment));
  out.tab(1).println("}");
  if (generateRelations()) {
    IdentityDefinition identity=table.getIdentity();
    if (identity != null) {
      final String identityType=getJavaType(identity.getColumn().getType());
      final String identityFullId=getStrategy().getFullJavaIdentifier(identity);
      out.tab(1).overrideInherit();
      out.tab(1).println("public %s<%s, %s> getIdentity() {",Identity.class,recordType,identityType);
      out.tab(2).println("return %s;",identityFullId);
      out.tab(1).println("}");
    }
    if (primaryKey != null) {
      final String keyFullId=getStrategy().getFullJavaIdentifier(primaryKey);
      out.tab(1).overrideInherit();
      out.tab(1).println("public %s<%s> getPrimaryKey() {",UniqueKey.class,recordType);
      out.tab(2).println("return %s;",keyFullId);
      out.tab(1).println("}");
    }
    List<UniqueKeyDefinition> uniqueKeys=table.getUniqueKeys();
    if (uniqueKeys.size() > 0) {
      final List<String> keyFullIds=getStrategy().getFullJavaIdentifiers(uniqueKeys);
      out.tab(1).overrideInherit();
      out.tab(1).println("public %s<%s<%s>> getKeys() {",List.class,UniqueKey.class,recordType);
      out.tab(2).println("return %s.<%s<%s>>asList([[%s]]);",Arrays.class,UniqueKey.class,recordType,keyFullIds);
      out.tab(1).println("}");
    }
    List<ForeignKeyDefinition> foreignKeys=table.getForeignKeys();
    if (foreignKeys.size() > 0) {
      final List<String> keyFullIds=getStrategy().getFullJavaIdentifiers(foreignKeys);
      out.tab(1).overrideInherit();
      out.tab(1).println("public %s<%s<%s, ?>> getReferences() {",List.class,ForeignKey.class,recordType);
      out.tab(2).println("return %s.<%s<%s, ?>>asList([[%s]]);",Arrays.class,ForeignKey.class,recordType,keyFullIds);
      out.tab(1).println("}");
    }
  }
  if (updatable) {
    patternLoop:     for (    String pattern : database.getRecordVersionFields()) {
      Pattern p=Pattern.compile(pattern,Pattern.COMMENTS);
      for (      ColumnDefinition column : table.getColumns()) {
        if ((p.matcher(column.getName()).matches() || p.matcher(column.getQualifiedName()).matches())) {
          final String columnType=getJavaType(column.getType());
          final String columnId=getStrategy().getFullJavaIdentifier(column);
          out.tab(1).overrideInherit();
          out.tab(1).println("public %s<%s, %s> getRecordVersion() {",TableField.class,recordType,columnType);
          out.tab(2).println("return %s;",columnId);
          out.tab(1).println("}");
          break patternLoop;
        }
      }
    }
    timestampLoop:     for (    String pattern : database.getRecordTimestampFields()) {
      Pattern p=Pattern.compile(pattern,Pattern.COMMENTS);
      for (      ColumnDefinition column : table.getColumns()) {
        if ((p.matcher(column.getName()).matches() || p.matcher(column.getQualifiedName()).matches())) {
          final String columnType=getJavaType(column.getType());
          final String columnId=getStrategy().getFullJavaIdentifier(column);
          out.tab(1).overrideInherit();
          out.tab(1).println("public %s<%s, %s> getRecordTimestamp() {",TableField.class,recordType,columnType);
          out.tab(2).println("return %s;",columnId);
          out.tab(1).println("}");
          break timestampLoop;
        }
      }
    }
  }
  if (generateInstanceFields()) {
    out.tab(1).overrideInherit();
    out.tab(1).println("public %s as(%s alias) {",fullClassName,String.class);
    if (table.isTableValuedFunction())     out.tab(2).println("return new %s(alias, this, parameters);",fullClassName);
 else     out.tab(2).println("return new %s(alias, this);",fullClassName);
    out.tab(1).println("}");
  }
  if (generateInstanceFields()) {
    out.tab(1).javadoc("Rename this table");
    out.tab(1).println("public %s rename(%s name) {",fullClassName,String.class);
    if (table.isTableValuedFunction())     out.tab(2).println("return new %s(name, null, parameters);",fullClassName);
 else     out.tab(2).println("return new %s(name, null);",fullClassName);
    out.tab(1).println("}");
  }
  if (table.isTableValuedFunction()) {
    for (    boolean parametersAsField : new boolean[]{false,true}) {
      if (parametersAsField && table.getParameters().size() == 0)       break;
      out.tab(1).javadoc("Call this table-valued function");
      out.tab(1).print("public %s call(",fullClassName);
      printParameterDeclarations(out,table,parametersAsField);
      out.println(") {");
      out.tab(2).print("return new %s(getName(), null, new %s[] { ",fullClassName,Field.class);
      String separator="";
      for (      ParameterDefinition parameter : table.getParameters()) {
        out.print(separator);
        if (parametersAsField) {
          out.print("%s",getStrategy().getJavaMemberName(parameter));
        }
 else {
          out.print("%s.val(%s)",DSL.class,getStrategy().getJavaMemberName(parameter));
        }
        separator=", ";
      }
      out.println(" });");
      out.tab(1).println("}");
    }
  }
  generateTableClassFooter(table,out);
  out.println("}");
  out.close();
}
