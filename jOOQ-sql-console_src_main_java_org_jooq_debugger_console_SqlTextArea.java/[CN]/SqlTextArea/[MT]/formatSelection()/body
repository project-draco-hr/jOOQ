{
  String text=getSelectedText();
  if (text == null) {
    return;
  }
  String originalText=text;
  text=text.trim();
  if (text.length() == 0) {
    return;
  }
  int startIndex=originalText.indexOf(text);
  int endIndex=startIndex + text.length();
  text=text.replaceAll("[\\t\\n\\x0B\\f\\r]+"," ");
  String textIndent="  ";
  StringBuilder sb=new StringBuilder();
  int charCount=text.length();
  boolean isInQuotes=false;
  boolean isLineStart=false;
  String currentIndent="";
  Stack<Boolean> isParenthesisNewLineStack=new Stack<Boolean>();
  for (int i=0; i < charCount; i++) {
    char c=text.charAt(i);
    if (isInQuotes) {
      if (c == '\'') {
        isInQuotes=false;
      }
      sb.append(c);
    }
 else {
switch (c) {
case '\'':
{
          if (isLineStart) {
            isLineStart=false;
            sb.append(currentIndent);
          }
          isInQuotes=true;
          sb.append(c);
          break;
        }
case '(':
{
        boolean isNewLine=false;
        if (text.length() <= i + 1 || !text.substring(i + 1).matches("\\s*\\w+\\s*\\).*")) {
          while (text.length() > i + 1 && text.charAt(i + 1) == ' ') {
            i++;
          }
          isNewLine=true;
          if (isLineStart) {
            isLineStart=false;
            sb.append(currentIndent);
          }
          sb.append(c);
          sb.append('\n');
          isLineStart=true;
          currentIndent+=textIndent;
        }
 else {
          sb.append(c);
        }
        isParenthesisNewLineStack.push(isNewLine);
        break;
      }
case ')':
{
      if (!isParenthesisNewLineStack.isEmpty()) {
        boolean isNewLine=isParenthesisNewLineStack.pop();
        if (isNewLine) {
          if (isLineStart) {
            isLineStart=false;
          }
 else {
            sb.append('\n');
          }
          int length=currentIndent.length();
          length-=textIndent.length();
          if (length >= 0) {
            currentIndent=currentIndent.substring(0,length);
          }
          sb.append(currentIndent);
        }
      }
      sb.append(c);
      break;
    }
case ' ':
{
    if (!isLineStart && text.length() > i + 1 && isKeywordStart(text.substring(i + 1).trim())) {
      while (text.length() > i + 1 && text.charAt(i + 1) == ' ') {
        i++;
      }
      sb.append('\n');
      isLineStart=true;
    }
 else {
      sb.append(c);
    }
    break;
  }
default :
{
  if (isLineStart) {
    isLineStart=false;
    sb.append(currentIndent);
  }
  sb.append(c);
  break;
}
}
}
}
String newContent=sb.toString().replaceAll(" +\n","\n");
String newText=originalText.substring(0,startIndex) + newContent + originalText.substring(endIndex);
replaceSelection(newText);
}
