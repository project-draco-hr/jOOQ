{
  try {
    Class<? extends Factory> clazz=getDialect().getFactory();
    Constructor<? extends Factory> constructor=clazz.getConstructor(Connection.class,SchemaMapping.class);
    Connection con=DataSourceUtils.getConnection(getDataSource());
    Connection conToUse=con;
    if (nativeJdbcExtractor != null) {
      conToUse=nativeJdbcExtractor.getNativeConnection(con);
    }
    Factory factory=constructor.newInstance(conToUse,getSchemaMapping());
    currentFactory.set(factory);
    currentConnection.set(con);
    return factory;
  }
 catch (  Exception exc) {
    throw new DataAccessException("Failed to create jOOQ Factory",exc);
  }
}
