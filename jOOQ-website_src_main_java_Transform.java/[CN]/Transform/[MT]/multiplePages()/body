{
  InputStream isXML=Transform.class.getResourceAsStream(file("manual.xml"));
  InputStream isXSL=Transform.class.getResourceAsStream("html-pages.xsl");
  StreamSource xsl=new StreamSource(isXSL);
  TransformerFactory factory=TransformerFactory.newInstance();
  Transformer transformer=factory.newTransformer(xsl);
  Match manual=$(isXML);
  replaceVariables(manual);
  List<String> ids=manual.find("section").ids();
  HashSet<String> uniqueIds=new HashSet<String>(ids);
  if (ids.size() != uniqueIds.size()) {
    for (    String id : uniqueIds) {
      ids.remove(id);
    }
    throw new Exception("Duplicate section ids found! " + ids);
  }
  int blanks=0, completed=0;
  Filter f=new Filter(){
    @Override public boolean filter(    Context arg0){
      return Arrays.asList("section","redirect").contains($(arg0.element()).tag());
    }
  }
;
  for (  Match section : manual.xpath("//section | //redirect").each()) {
    Match sections=section.add(section.parents(f)).reverse();
    String path=path(StringUtils.join(sections.ids(),"/"));
    String relativePath=relative(path);
    String root=root();
    File dir=new File(path);
    dir.mkdirs();
    File file=new File(dir,"index.php");
    file.delete();
    FileOutputStream out=new FileOutputStream(file);
    if ("redirect".equals(section.tag())) {
      Match redirectSection=manual.xpath("//section[@id='" + section.attr("redirect-to") + "']");
      Match redirectSections=redirectSection.add(redirectSection.parents("section")).reverse();
      String redirectPath=path(StringUtils.join(redirectSections.ids(),"/"));
      PrintWriter o=new PrintWriter(out);
      o.println("<?php header('Location: " + relativePath + redirectPath+ "'); ?>");
      o.flush();
      System.out.println("[r] Redirecting section  " + path + " to "+ redirectPath);
    }
 else {
      PrintStream stream=System.out;
      boolean blank=StringUtils.isBlank(section.find("content").text());
      if (blank) {
        blanks++;
        stream=System.err;
      }
 else {
        completed++;
      }
      stream.print("[");
      stream.print(blank ? " " : "x");
      stream.println("] Transforming section " + path);
      Source source=new DOMSource(manual.document());
      Result target=new StreamResult(out);
      transformer.setParameter("sectionID",section.id());
      transformer.setParameter("relativePath",relativePath);
      transformer.setParameter("root",root);
      transformer.transform(source,target);
    }
    out.close();
  }
  System.out.println("    Completed sections : " + completed + " / "+ (blanks + completed)+ " ("+ (100 * completed / (blanks + completed))+ "%)");
}
